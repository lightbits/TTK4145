
Network:
    client_listen_port = 10012
    master_listen_port = 20012

    // trenger vi å kunne sende direkte til master?
    // eller holder det å bare (sløsig) broadcaste alt?
    LaunchClientWorker(from_master, to_master):
        socket = CreateSocket(":client_listen_port")
        listen(socket, from_master)
        broadcast(socket, master_listen_port, to_master)

    LaunchMasterWorker(from_client, to_clients):
        socket = CreateSocket(":master_listen_port")
        listen(socket, from_client)
        broadcast(socket, client_listen_port, to_clients)


Lift:
    target = 0
    next_target = 0
    for select {
        case f := <- next_target_changed:
            next_target = f

        caes <- door_timer:
            if last_passed_floor == target:
                completed_floor <- target
                if next_target != target:
                    target = next_target
                    state = Moving
                else:
                    state = Idle
        case f := <- floor_reached:
            if f == target:
                state = DoorOpen
        case btn := <- button_pressed:

        case <- stop_pressed:
            // ignore
        case <- obstruction:
            // ignore
    }




WaitForBackup:
    select {
        case p := <- incoming:
            if p.Protocol == CL_PING:
                go Master(p.Sender)
                return
            else:
                continue
    }


Master(backup):
    for select:
        case c := <- client_timed_out:
            if backup == c:
                go WaitForBackup
                return


Client(master_address):
    time_to_send := time.NewTicker(1 * time.Second)
    timeout_timer := time.NewTimer(4 * time.Second)
    var status Status
    for select:
        case <- time_to_send.C:
            p := ClientStatusPacket{
                Cl_UPDATE,
                status
            }
            outgoing <- Encode(p)

        cae u := <- incoming:
            if u.Protocol == SV_UPDATE:
                timeout_timer.Reset()

        case <- timeout_timer
            go WaitForMaster()
            return


Backup(master_address):

WaitForMaster(queue):
    time_to_broadcast = time.NewTicker(1 * time.Second)
    for select:
        case <- time_to_broadcast.C:
            p := PingPacket{CL_PING}
            outgoing_all <- Encode(p)

        case u := <- incoming:
            if u.Protocol == SV_UPDATE:
                go Client(u.Sender)
                return

        case <- cleared_floor:
            f := GetNextFloorInQueue()
            new_target_floor <- f


main:
    go Lift()
    WaitForMaster()
